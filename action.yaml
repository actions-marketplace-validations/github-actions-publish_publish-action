name: 'Publish Github Action'
description: 'Publishes Github action and tags release'
inputs:
  branch:
    description: Branch to commit action to. Default will use the current.
    required: false
  tag:
    description: name of the git tag to use to tag the action.
    required: true
    default: v1

runs:
  using: "composite"
  steps:
    - run: |
        git config --global user.email "${{github.event.pusher.email}}"
        git config --global user.name "${{github.event.pusher.name}}"
      shell: bash
    - run: |
        if [ ! -z "${{ inputs.branch }}" ]
        then
          # make a temp directory to store repo contents in.
          TEMP_DIR=`mktemp -d`
          cp -r -a . $TEMP_DIR/
          # switch to the branch we are going to publish to.
          git switch -c ${{ inputs.branch }}
        
          # remove contents and replace with contents stored in temp directory.
          rm -rf ./*
          cp -r -a $TEMP_DIR/* .
          git add . || :
          
          # If there is a dist folder, commit it.
          if [ -d dist ]
          then
            git add -f dist || :
          # only commit node_modules if there is no dist.
          elif [ -d node_modules ]
          then
            git add -f node_modules || :
          fi
        
          git commit -m "Release for ${{ inputs.tag }}" || :
          git push -f --set-upstream origin ${{ inputs.branch }} || :
        fi
          
        git tag -f -a ${{ inputs.tag }} -m "Release for ${{ inputs.tag }}"
        git push -f --tags
      shell: bash